<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1 class="m-0">Reporte mensual</h1>
      </div>
      <!-- /.col -->

      <!-- /.col -->
    </div>
    <!-- /.row -->
  </div>
  <!-- /.container-fluid -->
</div>
<section class="content">
  <div class="container-fluid">
    <div class="card">
      <div class="card-header">
        <h4 class="card-title">Seleccionar mes y año</h4>
      </div>

      <div class="card-body">
        <div class="row">
          <form [formGroup]="dateForm" (ngSubmit)="submit()" class="row">
            <select
              class="form-control mb-0 text-gray-800"
              style="width: 150px; margin-left: 25px"
              formControlName="month"
            >
              <option value="1">Enero</option>
              <option value="2">Febrero</option>
              <option value="3">Marzo</option>
              <option value="4">Abril</option>
              <option value="5">Mayo</option>
              <option value="6">Junio</option>
              <option value="7">Julio</option>
              <option value="8">Agosto</option>
              <option value="9">Septiembre</option>
              <option value="10">Octubre</option>
              <option value="11">Noviembre</option>
              <option value="12">Diciembre</option>
            </select>
            <select
              class="form-control mb-0 text-gray-800"
              style="width: 100px; margin-left: 25px"
              formControlName="year"
            >
              <option value="{{ year }}" *ngFor="let year of yearList">
                {{ year }}
              </option>
            </select>
            <div style="padding-left: 20px">
              <button type="submit" class="btn btn-success">
                Obtener datos <i class="fas fa-retweet"></i>
              </button>
            </div>
          </form>
          <div style="padding-left: 20px">
            <button class="btn btn-success" (click)="generatePdf()">
              Generar PDF <i class="fas fa-retweet"></i>
            </button>
          </div>

          <div style="padding-left: 10px">
            <button class="btn btn-success" routerLink="tipos-datos">
              Tipos de datos <i class="fas fa-clipboard-list"></i>
            </button>
          </div>
          <div style="padding-left: 10px" *ngIf="!haveData">
            <button class="btn btn-success" (click)="showForm()">
              Agregar datos <i class="fas fa-clipboard-list"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="card" *ngIf="salesData && salesData.length > 0">
      <div class="card-header">
        <h4 class="card-title">Ventas</h4>
      </div>
      <div class="card-body">
        <table class="row-border hover table" aria-label="Tabla">
          <thead>
            <tr>
              <th
                rowspan="2"
                class="text-center table-valign-middle"
                style="vertical-align: middle"
              >
                Documento
              </th>
              <th colspan="2" class="text-center">Mes Actual</th>
              <th colspan="3" class="text-center">Mes Anterior</th>
              <th colspan="3" class="text-center">Año anterior</th>
            </tr>
            <tr>
              <th>Cantidad</th>
              <th>Monto</th>
              <th>Cantidad</th>
              <th>Monto</th>
              <th>% Dif.</th>
              <th>Cantidad</th>
              <th>Monto</th>
              <th>% Dif.</th>
            </tr>
          </thead>
          <tbody>
            @for(item of salesData; track item.id) {
            <tr>
              <td>{{ item.name }}</td>
              <td class="text-right">{{ item.currentMonthCount | number }}</td>
              <td class="text-right">
                ${{ item.currentMonth | number : "1.0-0" }}
              </td>

              <td class="text-right">{{ item.previousMonthCount | number }}</td>
              <td class="text-right">
                ${{ item.previousMonth | number : "1.0-0" }}
              </td>
              <td
                class="text-right"
                [ngClass]="{
                  'text-success':
                    calculatePercentageVariation(
                      item.currentMonth,
                      item.previousMonth
                    ) >= 0,
                  'text-danger':
                    calculatePercentageVariation(
                      item.currentMonth,
                      item.previousMonth
                    ) < 0
                }"
              >
                {{
                  calculatePercentageVariation(
                    item.currentMonth,
                    item.previousMonth
                  )
                }}%
              </td>

              <td class="text-right">{{ item.previousYearCount | number }}</td>
              <td class="text-right">
                ${{ item.previousYear | number : "1.0-0" }}
              </td>
              <td
                class="text-right"
                [ngClass]="{
                  'text-success':
                    calculatePercentageVariation(
                      item.currentMonth,
                      item.previousYear
                    ) >= 0,
                  'text-danger':
                    calculatePercentageVariation(
                      item.currentMonth,
                      item.previousYear
                    ) < 0
                }"
              >
                {{
                  calculatePercentageVariation(
                    item.currentMonth,
                    item.previousYear
                  )
                }}%
              </td>
            </tr>
            }
            <!-- Fila de totales -->
            <tr class="table-info font-weight-bold" *ngIf="salesResponse">
              <td><strong>TOTAL</strong></td>
              <td class="text-right">
                <strong>{{ salesResponse.countCurrentMonth | number }}</strong>
              </td>
              <td class="text-right">
                <strong
                  >${{
                    salesResponse.totalCurrentMonth | number : "1.0-0"
                  }}</strong
                >
              </td>
              <td class="text-right">
                <strong>{{ salesResponse.countPreviousMonth | number }}</strong>
              </td>
              <td class="text-right">
                <strong
                  >${{
                    salesResponse.totalPreviousMonth | number : "1.0-0"
                  }}</strong
                >
              </td>
              <td
                class="text-right"
                [ngClass]="{
                  'text-success':
                    calculatePercentageVariation(
                      salesResponse.totalCurrentMonth,
                      salesResponse.totalPreviousMonth
                    ) >= 0,
                  'text-danger':
                    calculatePercentageVariation(
                      salesResponse.totalCurrentMonth,
                      salesResponse.totalPreviousMonth
                    ) < 0
                }"
              >
                <strong
                  >{{
                    calculatePercentageVariation(
                      salesResponse.totalCurrentMonth,
                      salesResponse.totalPreviousMonth
                    )
                  }}%</strong
                >
              </td>
              <td class="text-right">
                <strong>{{ salesResponse.countPreviousYear | number }}</strong>
              </td>
              <td class="text-right">
                <strong
                  >${{
                    salesResponse.totalPreviousYear | number : "1.0-0"
                  }}</strong
                >
              </td>
              <td
                class="text-right"
                [ngClass]="{
                  'text-success':
                    calculatePercentageVariation(
                      salesResponse.totalCurrentMonth,
                      salesResponse.totalPreviousYear
                    ) >= 0,
                  'text-danger':
                    calculatePercentageVariation(
                      salesResponse.totalCurrentMonth,
                      salesResponse.totalPreviousYear
                    ) < 0
                }"
              >
                <strong
                  >{{
                    calculatePercentageVariation(
                      salesResponse.totalCurrentMonth,
                      salesResponse.totalPreviousYear
                    )
                  }}%</strong
                >
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Resumen general -->
    <div class="row" *ngIf="salesResponse">
      <!-- Mes Actual -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">
              <i class="fas fa-calendar-alt mr-2"></i>Mes Actual
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-3">
                <div class="description-block border-right">
                  <span class="description-percentage text-primary">
                    <i class="fas fa-file-invoice"></i>
                  </span>
                  <h5 class="description-header">
                    {{ salesResponse.countCurrentMonth }}
                  </h5>
                  <span class="description-text">DOCS</span>
                </div>
              </div>
              <div class="col-3">
                <div class="description-block border-right">
                  <span class="description-percentage text-success">
                    <i class="fas fa-dollar-sign"></i>
                  </span>
                  <h5 class="description-header">
                    ${{ salesResponse.totalCurrentMonth | number : "1.0-0" }}
                  </h5>
                  <span class="description-text">VENTAS</span>
                </div>
              </div>
              <div class="col-3">
                <div class="description-block border-right">
                  <span class="description-percentage text-info">
                    <i class="fas fa-shopping-cart"></i>
                  </span>
                  <h5 class="description-header">
                    ${{
                      salesResponse.totalCurrentMonthCost || 0
                        | number : "1.0-0"
                    }}
                  </h5>
                  <span class="description-text">COSTO</span>
                </div>
              </div>
              <div class="col-3">
                <div class="description-block">
                  <span class="description-percentage text-warning">
                    <i class="fas fa-coins"></i>
                  </span>
                  <h5 class="description-header">
                    ${{
                      salesResponse.totalCurrentMonthExtraCosts || 0
                        | number : "1.0-0"
                    }}
                  </h5>
                  <span class="description-text">C.EXTRA</span>
                </div>
              </div>
            </div>
            <div class="row mt-3" *ngIf="salesResponse.totalGrossCurrentMonth">
              <div class="col-12">
                <div class="text-center">
                  <span class="badge badge-success badge-lg">
                    <i class="fas fa-chart-line mr-1"></i>
                    Ganancia: ${{
                      salesResponse.totalGrossCurrentMonth | number : "1.0-0"
                    }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Comparación con Mes Anterior -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header bg-warning text-white">
            <h5 class="card-title mb-0">
              <i class="fas fa-calendar-minus mr-2"></i>vs Mes Anterior
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-3">
                <div class="description-block border-right">
                  <span
                    class="description-percentage"
                    [ngClass]="{
                      'text-success':
                        salesResponse.countCurrentMonth >=
                        salesResponse.countPreviousMonth,
                      'text-danger':
                        salesResponse.countCurrentMonth <
                        salesResponse.countPreviousMonth
                    }"
                  >
                    <i
                      class="fas"
                      [ngClass]="{
                        'fa-arrow-up':
                          salesResponse.countCurrentMonth >=
                          salesResponse.countPreviousMonth,
                        'fa-arrow-down':
                          salesResponse.countCurrentMonth <
                          salesResponse.countPreviousMonth
                      }"
                    ></i>
                  </span>
                  <h5 class="description-header">
                    {{ salesResponse.countPreviousMonth }}
                  </h5>
                  <span class="description-text">DOCS</span>
                </div>
              </div>
              <div class="col-3">
                <div class="description-block border-right">
                  <span
                    class="description-percentage"
                    [ngClass]="{
                      'text-success':
                        calculatePercentageVariation(
                          salesResponse.totalCurrentMonth,
                          salesResponse.totalPreviousMonth
                        ) >= 0,
                      'text-danger':
                        calculatePercentageVariation(
                          salesResponse.totalCurrentMonth,
                          salesResponse.totalPreviousMonth
                        ) < 0
                    }"
                  >
                    {{
                      calculatePercentageVariation(
                        salesResponse.totalCurrentMonth,
                        salesResponse.totalPreviousMonth
                      )
                    }}%
                  </span>
                  <h5 class="description-header">
                    ${{ salesResponse.totalPreviousMonth | number : "1.0-0" }}
                  </h5>
                  <span class="description-text">VENTAS</span>
                </div>
              </div>
              <div class="col-3">
                <div class="description-block border-right">
                  <span
                    class="description-percentage"
                    [ngClass]="{
                      'text-success':
                        calculatePercentageVariation(
                          salesResponse.totalCurrentMonthCost || 0,
                          salesResponse.totalPreviousMonthCost || 0
                        ) >= 0,
                      'text-danger':
                        calculatePercentageVariation(
                          salesResponse.totalCurrentMonthCost || 0,
                          salesResponse.totalPreviousMonthCost || 0
                        ) < 0
                    }"
                  >
                    {{
                      calculatePercentageVariation(
                        salesResponse.totalCurrentMonthCost || 0,
                        salesResponse.totalPreviousMonthCost || 0
                      )
                    }}%
                  </span>
                  <h5 class="description-header">
                    ${{
                      salesResponse.totalPreviousMonthCost || 0
                        | number : "1.0-0"
                    }}
                  </h5>
                  <span class="description-text">COSTO</span>
                </div>
              </div>
              <div class="col-3">
                <div class="description-block">
                  <span
                    class="description-percentage"
                    [ngClass]="{
                      'text-success':
                        calculatePercentageVariation(
                          salesResponse.totalCurrentMonthExtraCosts || 0,
                          salesResponse.totalPreviousMonthExtraCosts || 0
                        ) >= 0,
                      'text-danger':
                        calculatePercentageVariation(
                          salesResponse.totalCurrentMonthExtraCosts || 0,
                          salesResponse.totalPreviousMonthExtraCosts || 0
                        ) < 0
                    }"
                  >
                    {{
                      calculatePercentageVariation(
                        salesResponse.totalCurrentMonthExtraCosts || 0,
                        salesResponse.totalPreviousMonthExtraCosts || 0
                      )
                    }}%
                  </span>
                  <h5 class="description-header">
                    ${{
                      salesResponse.totalPreviousMonthExtraCosts || 0
                        | number : "1.0-0"
                    }}
                  </h5>
                  <span class="description-text">C.EXTRA</span>
                </div>
              </div>
            </div>
            <div class="row mt-3" *ngIf="salesResponse.totalGrossPreviousMonth">
              <div class="col-12">
                <div class="text-center">
                  <span class="badge badge-success badge-lg">
                    <i class="fas fa-chart-line mr-1"></i>
                    Ganancia: ${{
                      salesResponse.totalGrossPreviousMonth | number : "1.0-0"
                    }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Comparación con Año Anterior -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header bg-secondary text-white">
            <h5 class="card-title mb-0">
              <i class="fas fa-history mr-2"></i>vs Año Anterior
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-3">
                <div class="description-block border-right">
                  <span
                    class="description-percentage"
                    [ngClass]="{
                      'text-success':
                        salesResponse.countCurrentMonth >=
                        salesResponse.countPreviousYear,
                      'text-danger':
                        salesResponse.countCurrentMonth <
                        salesResponse.countPreviousYear
                    }"
                  >
                    <i
                      class="fas"
                      [ngClass]="{
                        'fa-arrow-up':
                          salesResponse.countCurrentMonth >=
                          salesResponse.countPreviousYear,
                        'fa-arrow-down':
                          salesResponse.countCurrentMonth <
                          salesResponse.countPreviousYear
                      }"
                    ></i>
                  </span>
                  <h5 class="description-header">
                    {{ salesResponse.countPreviousYear }}
                  </h5>
                  <span class="description-text">DOCS</span>
                </div>
              </div>
              <div class="col-3">
                <div class="description-block border-right">
                  <span
                    class="description-percentage"
                    [ngClass]="{
                      'text-success':
                        calculatePercentageVariation(
                          salesResponse.totalCurrentMonth,
                          salesResponse.totalPreviousYear
                        ) >= 0,
                      'text-danger':
                        calculatePercentageVariation(
                          salesResponse.totalCurrentMonth,
                          salesResponse.totalPreviousYear
                        ) < 0
                    }"
                  >
                    {{
                      calculatePercentageVariation(
                        salesResponse.totalCurrentMonth,
                        salesResponse.totalPreviousYear
                      )
                    }}%
                  </span>
                  <h5 class="description-header">
                    ${{ salesResponse.totalPreviousYear | number : "1.0-0" }}
                  </h5>
                  <span class="description-text">VENTAS</span>
                </div>
              </div>
              <div class="col-3">
                <div class="description-block border-right">
                  <span
                    class="description-percentage"
                    [ngClass]="{
                      'text-success':
                        calculatePercentageVariation(
                          salesResponse.totalCurrentMonthCost || 0,
                          salesResponse.totalPreviousYearCost || 0
                        ) >= 0,
                      'text-danger':
                        calculatePercentageVariation(
                          salesResponse.totalCurrentMonthCost || 0,
                          salesResponse.totalPreviousYearCost || 0
                        ) < 0
                    }"
                  >
                    {{
                      calculatePercentageVariation(
                        salesResponse.totalCurrentMonthCost || 0,
                        salesResponse.totalPreviousYearCost || 0
                      )
                    }}%
                  </span>
                  <h5 class="description-header">
                    ${{
                      salesResponse.totalPreviousYearCost || 0
                        | number : "1.0-0"
                    }}
                  </h5>
                  <span class="description-text">COSTO</span>
                </div>
              </div>
              <div class="col-3">
                <div class="description-block">
                  <span
                    class="description-percentage"
                    [ngClass]="{
                      'text-success':
                        calculatePercentageVariation(
                          salesResponse.totalCurrentMonthExtraCosts || 0,
                          salesResponse.totalPreviousYearExtraCosts || 0
                        ) >= 0,
                      'text-danger':
                        calculatePercentageVariation(
                          salesResponse.totalCurrentMonthExtraCosts || 0,
                          salesResponse.totalPreviousYearExtraCosts || 0
                        ) < 0
                    }"
                  >
                    {{
                      calculatePercentageVariation(
                        salesResponse.totalCurrentMonthExtraCosts || 0,
                        salesResponse.totalPreviousYearExtraCosts || 0
                      )
                    }}%
                  </span>
                  <h5 class="description-header">
                    ${{
                      salesResponse.totalPreviousYearExtraCosts || 0
                        | number : "1.0-0"
                    }}
                  </h5>
                  <span class="description-text">C.EXTRA</span>
                </div>
              </div>
            </div>
            <div class="row mt-3" *ngIf="salesResponse.totalGrossPreviousYear">
              <div class="col-12">
                <div class="text-center">
                  <span class="badge badge-success badge-lg">
                    <i class="fas fa-chart-line mr-1"></i>
                    Ganancia: ${{
                      salesResponse.totalGrossPreviousYear | number : "1.0-0"
                    }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" *ngIf="data.length !== 0">
      <div class="card-header">
        <h4 class="card-title">Datos</h4>
      </div>
      <div class="card-body">
        <p *ngFor="let item of data">
          {{ item.title }}:
          {{
            item.isMoney ? "$" + (item.value | number) : (item.value | number)
          }}
        </p>
      </div>
    </div>
    <div class="card" *ngIf="compras.length !== 0">
      <div class="card-header">
        <h4 class="card-title">Compras</h4>
      </div>
      <div class="card-body">
        <table class="row-border hover table" aria-label="Tabla">
          <thead>
            <tr>
              <th colspan="3">Mes actual</th>
              <th colspan="3">Mes anterior</th>
            </tr>
            <tr>
              <th>Cantidad</th>
              <th>Monto</th>
              <th>Costo</th>
              <th>Cantidad</th>
              <th>Monto</th>
              <th>Costo</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>{{ currentMonthCount | number }}</td>
              <td>${{ currentMonthTotal | number }}</td>
              <td>${{ currentMonthTotalCost | number }}</td>
              <td>
                {{ previousMonthCount | number }} ({{
                  calculatePercentageVariation(
                    currentMonthTotal,
                    previousMonthTotal
                  )
                }}%)
              </td>
              <td>
                ${{ previousMonthTotal | number }} ({{
                  calculatePercentageVariation(
                    currentMonthTotal,
                    previousMonthTotal
                  )
                }}%)
              </td>
              <td>
                ${{ previousMonthTotalCost | number }} ({{
                  calculatePercentageVariation(
                    currentMonthTotalCost,
                    previousMonthTotalCost
                  )
                }}%)
              </td>
            </tr>
          </tbody>
        </table>
        <br />
        <table class="row-border hover table" aria-label="Tabla">
          <thead class="table-light">
            <tr>
              <th>Proveedor</th>
              <th>Documento</th>
              <th>Fecha</th>
              <th>Monto</th>
              <th>Costo</th>
              <th>Tipo</th>
              <th>Observaciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of compras">
              <td>{{ item.proveedor.nombre }} ({{ item.proveedor.rut }})</td>
              <td>(T{{ item.tipo_documento.id }}) - {{ item.documento }}</td>
              <td [attr.data-order]="item.fecha_documento">
                {{ item.fecha_documento | date : "dd/MM/yyyy" : "UTC + 3" }}
              </td>
              <td>
                ${{
                  item.monto_neto_documento + item.monto_imp_documento
                    | currency : "CLP" : "" : "1.0-0"
                }}
              </td>
              <td>
                ${{
                  item.costo_neto_documento + item.costo_imp_documento
                    | currency : "CLP" : "" : "1.0-0"
                }}
              </td>

              <td>
                {{ item.tipo_compra.tipo_compra }}
              </td>

              <td>{{ item.observaciones }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
<app-agregar-datos-reporte
  [show]="showAddForm"
  [month]="month"
  [year]="year"
></app-agregar-datos-reporte>
